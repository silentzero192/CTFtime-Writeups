from os import urandom
from hashlib import sha1
from Crypto.Cipher import AES
from Crypto.Util.Padding import pad

FLAG = b'BCCTF{FAKE_FLAG}'
curves = {"Bob": (269888314686234481585305002314883090443, 131076210654559479889474353969687086349, 252335675602179529081759818831899630906, 243161585467794109593055650031600059604, (244647877822692770772950071726051930424, 56718141861424197638718743587793646962)), "Groble": (268525153172955111141710495336916092359, 77595304868970631676646486623142667136, 160403463162280816897086348452838851324, 206806643805124551064801254884133226846, (37681108561430287733859095695707147902, 161275254799741651413651876016867205842)), "Little Bro": (183240421760695879724412445337013332527, 76325016343214893824187177353976404488, 155822588554759013957564270515926370965, 25502673642681606446574432628667597596, (83507200639284580474125952128930314378, 170182503746726216888481226345786807845)), "67 Curve": (192454301557964930167859351016899482507, 71187355946821344370360761485334876077, 181072996743315975633731135868992934121, 175692111150753161963368858797957814623, (161256723125768985761841258202831053385, 186813707789077648623619548929634341765)), "Pirate": (272149525642219144800657692771418035983, 209038140734991835959431713118511684457, 135559400816157282630878165602343750132, 71421758864734102461666686861253884052, (266000024077965332018958932989735820640, 186482230450966666287293831129381693633)), "Grotesquerie": (281640707051477723922431248146263249263, 4228811402251451906153366709175741843, 166648058149121018401303586330660519948, 121108987557531222484197285421363087816, (210216502264765522057296302040271796774, 258910711847557938504712097477201251292)), "Oreo": (238933139186704835007331195126674626819, 148800275155432176789675671717649178947, 194712145387632081529950583587577914695, 8422369410008431281908740305449726131, (214107090031166662856603547229629485598, 198786422161852259729993375432835104401)), "GIRTH": (279470893451906031690181747685564523443, 51524756704382702606494424571744369870, 97007814789050662157984141166209204891, 19643172479067545031125906362361687951, (134583983158657408637087802533049744938, 171290691770585790025175378612491577797)), "Killer": (326960867292890420231333097070773051791, 119466473442683339957797266360793941041, 326808264520995048799425942845086869332, 320374975710189883644684234126487423869, (297646185581420607634528514710990886369, 1397946169548906451779518171880755274)), "Potato Tom": (235227353477833908641923245349756136387, 77899666928662297917716400314416579812, 147819998876578925455649422255310752850, 171018424717799028919028757892322855336, (64001791268385309450346611192102902597, 167134686418457127124422695158808176959)), "Yuppie": (76469852099082028501622314516455202939048866361133192643377978302957889123011, 29593063869483809644325773371283427750221241942945336621311770562615878536728, 46944673249371254820030084251915716547690471957852576062506245209712320871900, 49538921975313620306349633628298900912601210233057453769633690676163185861224, (3599662967501538841577461938472169407534090655690547730454327112638103057380, 73227879497805365858266246055976665389396300078415737534150722688748395567655)), "There is nothing left to fear, for I have nothing left": (106108891100490465123543547230405621684076409380575275673385457668382318801851, 77141232175612693431753160100979280210411661504760076714854200521414824976003, 85920384892887474821535544821828507127896758742605339993535700968011416104605, 76996974402946473566914549927867811060183763421122766953044941914507310172391, (1792557129213615354177696012960729395567036788930779537904302889730118144123, 24853231305235349492294696077757730773779531408662770743635882659044741700588)), "Ivan the mediocre": (87767594321204896166568689260330536563454131001123673390843042350527817271603, 5729513430864168251198524496192024459692439616427228114400479181868505448505, 19974167217068029430914615023918609587547710979235564030946419186914004303665, 41945166145859324874862123237416294141698804003123817614291391190722901105315, (47660057753457594942954475641088142165394924334836636849312658600071916352393, 26668805528714253384968670692919989293908510989244736780496207897464512878455)), "The divine face of God": (74141500604966490808806245865769965377555633080107184890643770445143397568239, 23019548889632988753814220317950214318268975297702451582105613733092847697300, 24679096829066209595003507387532186083137826335920816063574445311351324707052, 18860997225851637230725384575363436588409660576426480512809830001739303933513, (30500194405060970127745704857664752062829929611333144855177073083710126415685, 24735410460856146331223748012900133369098997572923650660460175943494959947026)), "Blackbeard": (89824101668236290406535940832213932908152964340398598753196561441754392068271, 23936020963452117235165560977404151959687141505034402665911763038914417266178, 2388739415170399172405686466771505071700757776576545996009190675113188560839, 84329223959197919841633838374058989875596629707299723222689290052793861349023, (66597553792819163296073909063331116233704132440929179209576643289935526087574, 17040893144887452333002475999152653058424712223637024801864328470812951218822)), "Daquavious Pork": (92477645447719597722241924944220804509189685020218853319582456492812008432951, 12077440433756325151450430637702142241115682027769009672424134533824264621982, 5820075301718484807190615376227445775094236611137942662646164904513344955506, 79756563336507309847840508616642202952716246885851710551602577895600001192101, (23535374861808337349161906509731226338003476556014177115380062081237358087693, 40704090379575014906510835547748879494479225636219808088614211329238685473492)), "The beast with seven heads and ten horns": (90096117644276651006245034015520444343787915469919513704629996128439647972103, 81281534515489238850875304893951201917576597827091154282345488123483179779142, 40154963052933189867294748942765155232969424684697326318278494298950003396497, 5125242122045632937458257422196651603231254802200747322295315767165375852192, (10148379361637733608646265870328052054294777496910725581658548531208008654215, 56466079438011535064067030475730722517282890424650087891538049141802469760281)), "Rose": (108200414650718782495137349155544964130551811606151002058672066347390341805511, 79600096128738203296340605411462276522418334601098496193870916473596142550826, 79993256570196876985698364154102220399202715126713884911635696507151966254498, 28154204382157524314372846129552315348587271867713444190324685668975528183279, (67380556471509544611965111603705755823894487749347053250476749466019619926730, 15952259745912210753356463156621570600183544612649887553611971872931518568487)), "Merced": (66841349264543294747026735063308045794327457786047377647739864327585488664163, 28592962818674660420751239387881762424305106818684700669612434569329303086871, 27574780101477037256884760178041645518896916278106543108537338663255955413882, 4328965299662436523092241870192734921160638734028120826227340748791391121151, (51120903964940538996739481762400021475447418963024654132800130508081954334426, 52912995299149098277847198010655755990761101037718775273404583891972079062238)), "Truff": (84279305282056084762054094558255146059435186007694153050308439346737300661659, 25592075677640162025577268623858213476562165931736995545565277044734083939688, 19535487597032904343632223513329648788903829116083336173298917301914583012453, 3599928117234492975992531228489808610957826862596512703339564780668679881942, (43990892684194406531396899884445816162490106813668971355978881532610248157409, 48752806354201746308472105685232304767501378774493484957657893769239392382062)), "The Iron Maiden": (27691575034504128937811374951197812643334936938989751837045073374268169072815575700655822031271290473787033297250631, 23941498641272336753054391250847389249517235895220352395398542470294116545600800922153890525784872724702586504048930, 22715328572699725308435839971751741274017688002981058547624691022385882595182211107121241543352502759230356806821086, 27334838159747279382769210767361547077337397405162978882164458842177195928903231370623128059398873308060182814360925, (17162320288348246969321489997972592822783415170342531697362300131092678255576182765568291639214803797372374525024110, 24520908227851435676828618411959320862068542364414593073283504569708389279791166715844826349494285702936668056578228)), "Emulsive": (28203076345139660574397878140485984352903413748240918139825477190439765196530424346686684806161038249524591308283611, 10240598364512820094913127884653761617342110299721641153930064384230276290212523500137642624770454435973970004108243, 4477390320718946025693243219417790230431387735079276937426876030277804476386215371088689678317817943114805965239225, 15599206813589455811641037082605869358052995465728088546455629441999902488888220130782974161428855100663115873752500, (13178409128454292966907441122953953409955011616991140522121701902741505942308806278512088954526994268054925904239117, 18168117047118499156049588210524723774258405312334123151025022364356090384177162528094436042831358038913565128021732)), "Bit tricky innit?": (31020865137439758713698463993149949001394688861161038675960423291504290185848078056870948049486072295455563728401863, 28734289861236394037753276285757655630141528657845087573417196624863634250347833366417886605600383062129353970679027, 20687386531047782623357734896019835227140019228697702677870275550467748434005226140223425549192672584497049372748512, 22154166878256862491392213876348623846761585837944980743713836553003562664562627685421390056677494646666727297672852, (13791683884770173652202974051876088251836767806113169382838140290677570365640861086734684618133573955052497607052905, 498748369526913123973392425333922420830310955909986738637830734196507982063240178066234179327272111999879392795931)), "Big John": (5078981894210371894359683252143650093229268054361998956171819952160814069194479805698322596153544495639168746610437072292429639651871708064025226241007742483, 4485445749547740206968275024378079751847410071250959017181258259732717531106439611730305728109906176162889210588269002312454458620096094598288973201382659576, 154914307025393905844293545870944522063775091241116991509195396684753533021493520966584268904677536962082348646351426660908684982828278155488999731930255082, 3264332672209528206622675262082790080323139432843876773528349097762748276409549557277791487495240917013961701659309844209519878510008705916169671813553812755, (3035690231238578792432878783387220757378743865004461279201750976929189038880953936164021173141260474214804978063246766956482129341919503374465921767076126601, 2276883253071934912276181417699559150071470796536829986113367550388868936019641643319486097501505687570463279087058430765045675223385636247429449087063798416))}

class Point:
    def __init__(self, curve, x, y=None) -> None:
        self.curve = curve
        self.x = self.curve.f(x)
        yvals = self.compute_ys(x)
        if y is not None: 
            if y not in yvals:
                raise ValueError(f"The point ({x}, {y}) is not on curve.")
            self.y = y
        else:
            self.y = yvals[0]
    
    def __repr__(self) -> str:
        return f"Point ({self.x}, {self.y}) on {self.curve}"
    
    def __str__(self) -> str:
        return f"({self.x}, {self.y})"
    
    def __eq__(self, other) -> bool:
        return self.curve == other.curve and self.x == other.x and self.y == other.y

    def __neg__(self):
        return self.curve.neg_point(self)
    
    def __add__(self, other):
        if self.curve != other.curve:
            raise ValueError(f"{self} and {other} are on the different curves.")
        return self.curve.add_point(self, other)

    def __radd__(self, other):
        return self.__add__(other)

    def __sub__(self, other):
        return self.__add__(-other)

    def __mul__(self, a: int):
        return self.curve.mul_point(a, self)

    def __rmul__(self, a: int):
        return self.__mul__(a)
    
    def compute_ys(self, x: int) -> tuple:
        return self.curve.compute_ys(x)


class CrazyCurve:
    def __init__(self, f, a, b, c) -> None:
        self.f = f
        self.a = f(a)
        self.b = f(b)
        self.c = f(c)
        self.O = Point(self, a + c, b)

    def __call__(self, x: int, y=None) -> Point:
        return Point(self, x, y)
    
    def __str__(self) -> str:
        return f"CrazyCurve on {self.f} with parameters a={self.a}, b={self.b}, c={self.c}"
    
    def __repr__(self) -> str:
        return "A perfectly normal curve"
    
    def __eq__(self, other) -> bool:
        return self.f == other.f and self.a == other.a and self.b == other.b and self.c == other.c

    def compute_ys(self, x: int) -> tuple:
        y = sqrt(self.c^2 - (x - self.a)^2)
        if y not in self.f:
            raise ValueError(f"Point with {x=} is not on curve.")
        return (self.b + y, self.b - y)
    
    def neg_point(self, P: Point) -> Point:
        return Point(self, P.x, 2*self.b-P.y)

    def double_point(self, P: Point) -> Point:
        tx = P.x - self.a
        ty = P.y - self.b
        xval = (tx^2-ty^2)/self.c + self.a
        yval = 2*tx*ty/self.c + self.b
        return Point(self, xval, yval)

    def add_point(self, P: Point, Q: Point) -> Point:
        if P == Q:
            return self.double_point(P)
        ptx = P.x - self.a
        pty = P.y - self.b
        qtx = Q.x - self.a
        qty = Q.y - self.b
        xval = (ptx*qtx-qty*pty)/self.c + self.a
        yval = (ptx*qty+qtx*pty)/self.c + self.b
        return Point(self, xval, yval)

    def mul_point(self, n: int, P: Point) -> Point:
        R = self.O
        while n:
            if n & 1:
                R += P
            P += P
            n >>= 1
        return R


def load_curve(curve):
    p, a, b, c, G = curves[curve]
    C = CrazyCurve(GF(p), a, b, c)
    G = C(*G)
    return C, G

def proofs():
    C, G = load_curve(choice(list(curves)))
    P = G*randint(1, 2^128)
    Q = G*randint(1, 2^128)
    R = G*randint(1, 2^128)
    O = C.O
    # Proofs
    print("Addition Proofs:")
    print("\tCommutativity:", P + Q == Q + P)
    print("\tAssociativity:", (P + Q) + R == P + (Q + R))
    print("\tSubtractive Identity:", P - P == O)
    print("\tAdditive Identity:", P + O == P)
    print("Multiplication Proofs:")
    print("\tCommutativity:", 3*P == P*3)
    print("\tAssociativity:", (3*4)*P == 3*(4*P))
    print("\tDistributivity:", 3*(P + Q) == 3*P + 3*Q)
    print("\tIdentity:", 1*P == P)
    print("\tZero Property:", 0*P == O)
    print("\tDefinition:", 5*P == P + P + P + P + P)

def keygen(P: Point, size=2^128) -> tuple:
    privkey = randint(2, size)
    pubkey = P*privkey
    return (pubkey, privkey)

def simulate_exchange() -> int:
    C, G = load_curve(choice(list(curves)))
    Apub, Apriv = keygen(G)
    Bpub, Bpriv = keygen(G)
    print(f"Alice public key: {Apub}")
    print(f"Bob public key: {Bpub}")
    
    assert Apub*Bpriv == Bpub*Apriv
    ss = Apub*Bpriv
    return int(ss.x)

if __name__ == '__main__':
    ss = simulate_exchange()
    key = sha1(str(ss).encode()).digest()[:16]
    iv = urandom(16)
    cipher = AES.new(key, AES.MODE_CBC, iv)
    ct = cipher.encrypt(pad(FLAG, 16))
    data = {}
    data['iv'] = iv.hex()
    data['ciphertext'] = ct.hex()
    print(data)